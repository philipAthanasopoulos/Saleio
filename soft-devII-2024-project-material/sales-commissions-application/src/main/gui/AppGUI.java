package main.gui;

import main.domain.*;
import main.parser.*;
import main.reporter.*;

import java.util.List;
import java.util.ArrayList;

import java.io.File;
import java.io.IOException;

import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.border.EmptyBorder;
import javax.swing.JButton;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JScrollPane;
import javax.swing.JTextPane;
import javax.swing.ImageIcon;
import javax.swing.SwingConstants;
import javax.swing.SwingUtilities;
import javax.swing.UIManager;
import javax.swing.DebugGraphics;
import javax.swing.DefaultListModel;

import java.awt.EventQueue;
import java.awt.Font;
import java.awt.GridLayout;
import java.awt.Color;
import java.awt.Cursor;

/**
 * The App class is the main class of the application. It is responsible for
 * creating the GUI and handling the user's input.
 * @important The GUI is currently made with WindowBuilder extension for Eclipse.
 * Because of this, the code has autogenerated parts and some names are not
 * very descriptive. Make sure to change them when make changes to the GUI.
*/
public class AppGUI extends JFrame {
	private static final long serialVersionUID = 1L;
	private JPanel contentPane;
	private String applicationName = "Sales Commissions Application";
	private JPanel sidePanel;
	private List<Associate> associates; 
	private JList<String> associatesList; // change name
	private JFileChooser fileChooser;
	private JLabel associateFileLabel;
	private JTextPane associateFileTextPane;
	private AssociateSalesPanel associateSalesPanel;

	public void runApp() {
		EventQueue.invokeLater(() -> {
			try {
				AppGUI frame = new AppGUI();
				frame.setTitle(frame.applicationName);
				frame.setVisible(true);
			} catch (Exception e) {
				e.printStackTrace();
			}
		});
	}
	
	/**
	 * Create the frame.
	 */
	public AppGUI() {
		final DefaultListModel<String> listModel = new DefaultListModel<String>();
		associates = new ArrayList<Associate>();
		fileChooser = new JFileChooser();
		try {
			UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
			SwingUtilities.updateComponentTreeUI(fileChooser);
		} catch (Exception fileChooserException) {
			fileChooserException.printStackTrace();
		}


		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		setExtendedState(JFrame.MAXIMIZED_BOTH);
		setBounds(0, 0, 1920, 1080);
		contentPane = new JPanel();
		contentPane.setFocusable(false);
		contentPane.setFocusTraversalKeysEnabled(false);
		contentPane.setForeground(new Color(255, 255, 255));
		contentPane.setBackground(new Color(255, 255, 255));
		contentPane.setOpaque(false);
		contentPane.setBorder(new EmptyBorder(5, 5, 5, 5));
		contentPane.setBounds(0, 0, getWidth(), getHeight());

		setContentPane(contentPane);
		contentPane.setLayout(null);
		
		
		
		JScrollPane associateFileScrollPane = new JScrollPane();
		associateFileScrollPane.setBounds(1394, 208, 510, 794);
		contentPane.add(associateFileScrollPane);
		
		associateFileTextPane = new JTextPane();
		associateFileTextPane.setFont(new Font("Tahoma", Font.PLAIN, 18));
		associateFileTextPane.setEditable(false);
		associateFileScrollPane.setViewportView(associateFileTextPane);
		associateFileTextPane.setCaretPosition(0);
		
		JLabel associateListLabel = new JLabel("Associates");
		associateListLabel.setIconTextGap(10);
		associateListLabel.setIcon(new ImageIcon(AppGUI.class.getResource("/resources/icons8-admin-30.png")));
		associateListLabel.setFont(new Font("SansSerif", Font.PLAIN, 18));
		associateListLabel.setBounds(448, 153, 148, 44);
		contentPane.add(associateListLabel);
		
		associateFileLabel = new JLabel("No file to show");
		associateFileLabel.setIconTextGap(10);
		associateFileLabel.setIcon(new ImageIcon(AppGUI.class.getResource("/resources/icons8-file-35.png")));
		associateFileLabel.setFont(new Font("SansSerif", Font.PLAIN, 18));
		associateFileLabel.setBounds(1563, 147, 320, 56);
		contentPane.add(associateFileLabel);	
		
		sidePanel = new GradientPanel();
		sidePanel.setBounds(0, 0, 322, getHeight());
		contentPane.add(sidePanel);
		sidePanel.setLayout(null);
		
		JPanel actionsButtonsPanel = new JPanel();
		actionsButtonsPanel.setOpaque(false);
		actionsButtonsPanel.setBounds(0, 278, 322, 267);
		sidePanel.add(actionsButtonsPanel);
		actionsButtonsPanel.setLayout(new GridLayout(0, 1, 0, 0));
		
		JButton importFileButton = new JButton("Import file");
		importFileButton.setDebugGraphicsOptions(DebugGraphics.NONE_OPTION);
		importFileButton.setFocusable(false);
		importFileButton.setFocusPainted(false);
		importFileButton.setFocusTraversalKeysEnabled(false);
		importFileButton.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
		importFileButton.setIconTextGap(10);
		importFileButton.setHorizontalTextPosition(SwingConstants.LEFT);
		importFileButton.setIcon(new ImageIcon(AppGUI.class.getResource("/resources/icons8-add-file-30.png")));
		importFileButton.addActionListener((e) -> {
			if (fileChooser.showOpenDialog(null) == JFileChooser.APPROVE_OPTION) {
				try {
					File selectedFile = fileChooser.getSelectedFile();
					String fileExtension = getFileExtension(selectedFile);
					System.out.println("Tried to import :" + fileExtension);
					ParserFactory parserFactory = new ParserFactory();
					Parser parser = parserFactory.getParser(fileExtension);
					Associate newAssociate = parser.parseAssociateFromFile(selectedFile);
					associates.add(newAssociate);
					listModel.addElement(newAssociate.getName());
				} catch (NumberFormatException wrongNumberFormat) {
					JOptionPane.showMessageDialog(null, "Some numerical values may be words", "Error", JOptionPane.ERROR_MESSAGE);
				} catch (IOException ioException) {
					JOptionPane.showMessageDialog(null, "File not found", "Error", JOptionPane.ERROR_MESSAGE);
				} catch (Exception exception) {
					JOptionPane.showMessageDialog(null, "File not supported", "Error", JOptionPane.ERROR_MESSAGE);
				}
			}
		});
		importFileButton.setFont(new Font("SansSerif", Font.BOLD, 18));
		importFileButton.setBorder(null);
		importFileButton.setForeground(new Color(255, 255, 255));
		importFileButton.setBackground(new Color(0, 128, 128));
		importFileButton.setOpaque(false);
		actionsButtonsPanel.add(importFileButton);
		
		JButton addReceiptButton = new JButton("Add receipt");
		addReceiptButton.setFocusable(false);
		addReceiptButton.setFocusTraversalKeysEnabled(false);
		addReceiptButton.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
		addReceiptButton.setIconTextGap(10);
		addReceiptButton.setHorizontalTextPosition(SwingConstants.LEFT);
		addReceiptButton.setIcon(new ImageIcon(AppGUI.class.getResource("/resources/icons8-add-receipt-30.png")));
		addReceiptButton.setFont(new Font("SansSerif", Font.BOLD, 18));
		addReceiptButton.setBorder(null);
		addReceiptButton.setForeground(new Color(255, 255, 255));
		addReceiptButton.setBackground(new Color(0, 128, 128));
		addReceiptButton.setOpaque(false);
		addReceiptButton.addActionListener((e) -> {
			ReceiptForm receiptForm = new ReceiptForm(getSelectedAssociate());
			receiptForm.setLocationRelativeTo(null);
			receiptForm.setVisible(true);
		});
		actionsButtonsPanel.add(addReceiptButton);
		
		JButton exportFileButton = new JButton("Export as");
		exportFileButton.setFocusable(false);
		exportFileButton.setFocusTraversalKeysEnabled(false);
		exportFileButton.setCursor(Cursor.getPredefinedCursor(Cursor.HAND_CURSOR));
		exportFileButton.setIconTextGap(10);
		exportFileButton.setHorizontalTextPosition(SwingConstants.LEFT);
		exportFileButton.setIcon(new ImageIcon(AppGUI.class.getResource("/resources/icons8-send-file-30.png")));
		exportFileButton.setFont(new Font("SansSerif", Font.BOLD, 18));
		exportFileButton.setBorder(null);
		exportFileButton.setForeground(new Color(255, 255, 255));
		exportFileButton.setBackground(new Color(0, 128, 128));
		exportFileButton.setOpaque(false);
		exportFileButton.addActionListener((e) -> {
			FileType[] fileTypes = FileType.values();
			int choice = JOptionPane.showOptionDialog(null, "Choose file type", "Export as", JOptionPane.DEFAULT_OPTION, JOptionPane.PLAIN_MESSAGE, null, fileTypes , null);
			ReporterFactory reporterFactory = new ReporterFactory();
			Reporter reporter = reporterFactory.getReporter(fileTypes[choice].name() , getSelectedAssociate());
			reporter.saveFile();
		});
		actionsButtonsPanel.add(exportFileButton);
		
		JLabel appTitleLabel = new JLabel("");
		appTitleLabel.setIconTextGap(0);
		appTitleLabel.setIcon(new ImageIcon("C:\\Users\\Philip\\Downloads\\Sale.io (3).png"));
		appTitleLabel.setForeground(new Color(255, 255, 255));
		appTitleLabel.setFont(new Font("SansSerif", Font.BOLD, 22));
		appTitleLabel.setBounds(0, 0, 322, 147);
		sidePanel.add(appTitleLabel);
		
		JScrollPane associatesScrollPane = new JScrollPane();
		associatesScrollPane.setBounds(346, 208, 369, 471);
		contentPane.add(associatesScrollPane);
		
		associatesList = new JList<String>();
		associatesList.setFont(new Font("Tahoma", Font.PLAIN, 18));
		associatesList.setModel(listModel);
		associatesList.addListSelectionListener((evt) -> {
					if (evt.getValueIsAdjusting()) return;
					associateFileTextPane.setText(getSelectedAssociate().getFormattedFile());
					associateFileLabel.setText(getSelectedAssociate().getPersonalFile().getName());
					associateSalesPanel.setAssociate(getSelectedAssociate());
					
					String fileExtension = getFileExtension(getSelectedAssociate().getPersonalFile());
					setDisplayedFileIcon(fileExtension);
		});
		
		associatesScrollPane.setViewportView(associatesList);
		
		associateSalesPanel = new AssociateSalesPanel();
		associateSalesPanel.setBounds(757, 208, 599, 794);
		contentPane.add(associateSalesPanel);
		
		JButton displayRawFileButton = new JButton("Raw");
		displayRawFileButton.setFont(new Font("Tahoma", Font.PLAIN, 13));
		displayRawFileButton.addActionListener((e) -> {
			associateFileTextPane.setText(getSelectedAssociate().getRawFile());
		});
		displayRawFileButton.setBounds(1394, 165, 69, 32);
		contentPane.add(displayRawFileButton);
		
		JButton displayFormatedFileButton = new JButton("Format");
		displayFormatedFileButton.addActionListener((e) -> {
			associateFileTextPane.setText(getSelectedAssociate().getFormattedFile());
		});
		displayFormatedFileButton.setFont(new Font("Tahoma", Font.PLAIN, 13));
		displayFormatedFileButton.setBounds(1465, 165, 88, 32);
		contentPane.add(displayFormatedFileButton);
		
		GradientPanel gradientPanel = new GradientPanel();
		gradientPanel.setBounds(320, 0, 1602, 125);
		contentPane.add(gradientPanel);
	}
	
	public String getFileExtension(File file){
		String fileName = file.getName();
		int dotIndex = fileName.lastIndexOf('.');
		String result = (dotIndex == -1) ? "" : fileName.substring(dotIndex + 1);
		System.out.println(result);
		return result;
	}
	
	public void refreshAssociateFileTextPane(){
		associateFileTextPane.setText(getSelectedAssociate().getRawFile());
	}
	
	public Associate getSelectedAssociate(){
		return associates.get(associatesList.getSelectedIndex());
	}
	
	private void setDisplayedFileIcon(String fileExtension) {
		switch(fileExtension){
			case "txt":
				associateFileLabel.setIcon(new ImageIcon(AppGUI.class.getResource("/resources/icons8-txt-35.png")));
				break;
			case "xml":
				associateFileLabel.setIcon(new ImageIcon(AppGUI.class.getResource("/resources/icons8-xml-35.png")));
				break;
			default:
				break;
		}
	}
}
		